<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiter Notes App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            800: '#1a1a1a',
                            700: '#262626',
                            600: '#333333',
                            500: '#404040',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #262626;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        /* Animation for buttons */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .animate-pulse-once {
            animation: pulse 0.5s ease-in-out;
        }
        
        /* Transition effects */
        .transition-all {
            transition: all 0.3s ease;
        }
        
        /* Split bill animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Custom alert */
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            max-width: 90%;
            animation: fadeIn 0.3s ease-out;
        }
        .custom-alert.success {
            border-left: 4px solid #10b981;
        }
        .custom-alert.warning {
            border-left: 4px solid #f59e0b;
        }
        .custom-alert.error {
            border-left: 4px solid #ef4444;
        }
        .custom-alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        .custom-alert.success i {
            color: #10b981;
        }
        .custom-alert.warning i {
            color: #f59e0b;
        }
        .custom-alert.error i {
            color: #ef4444;
        }

        /* Storage Permission Modal */
        .storage-permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
        }
        .storage-permission-content {
            background-color: #262626;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .storage-permission-icon {
            font-size: 3rem;
            color: #3b82f6;
            margin-bottom: 20px;
        }
        .storage-permission-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        .storage-permission-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .storage-permission-btn.allow {
            background-color: #3b82f6;
            color: white;
        }
        .storage-permission-btn.deny {
            background-color: #404040;
            color: #d1d5db;
        }
    </style>
</head>
<body class="bg-dark-800 text-gray-200 min-h-screen">
    <!-- Storage Permission Modal -->
    <div id="storage-permission-modal" class="storage-permission-modal hidden">
        <div class="storage-permission-content">
            <div class="storage-permission-icon">
                <i class="fas fa-database"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4">Permissão de Armazenamento</h2>
            <p class="text-gray-300 mb-4">
                Para que o aplicativo funcione corretamente offline, precisamos de permissão para armazenar dados localmente no seu dispositivo.
            </p>
            <p class="text-gray-400 text-sm mb-6">
                Suas informações ficarão apenas no seu dispositivo e não serão compartilhadas.
            </p>
            <div class="storage-permission-buttons">
                <button id="deny-storage-btn" class="storage-permission-btn deny">
                    Negar
                </button>
                <button id="allow-storage-btn" class="storage-permission-btn allow">
                    Permitir
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Container -->
    <div id="custom-alert-container"></div>

    <!-- Main App Container -->
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-emerald-400">Waiter Notes</h1>
            <button id="settings-btn" class="text-gray-400 hover:text-white transition-all">
                <i class="fas fa-ellipsis-v text-xl"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Tables Grid -->
            <div id="tables-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-8">
                <!-- Tables will be added here dynamically -->
            </div>

            <!-- Add New Table Button -->
            <button id="add-table-btn" class="w-full py-3 bg-dark-700 hover:bg-dark-600 rounded-lg border-2 border-dashed border-gray-600 text-gray-400 hover:text-white transition-all flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i> Adicionar Mesa
            </button>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Table Modal -->
    <div id="add-table-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-700 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Adicionar Nova Mesa</h3>
                <button id="close-add-table-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2">Nome da Mesa</label>
                    <input type="text" id="table-name" class="w-full bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block mb-2">Cor da Mesa</label>
                    <div class="grid grid-cols-5 gap-2">
                        <div class="color-option h-8 rounded cursor-pointer bg-red-500 border-2 border-transparent hover:border-white" data-color="bg-red-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-blue-500 border-2 border-transparent hover:border-white" data-color="bg-blue-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-green-500 border-2 border-transparent hover:border-white" data-color="bg-green-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-yellow-500 border-2 border-transparent hover:border-white" data-color="bg-yellow-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-purple-500 border-2 border-transparent hover:border-white" data-color="bg-purple-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-pink-500 border-2 border-transparent hover:border-white" data-color="bg-pink-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-indigo-500 border-2 border-transparent hover:border-white" data-color="bg-indigo-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-emerald-500 border-2 border-transparent hover:border-white" data-color="bg-emerald-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-amber-500 border-2 border-transparent hover:border-white" data-color="bg-amber-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-cyan-500 border-2 border-transparent hover:border-white" data-color="bg-cyan-500"></div>
                    </div>
                </div>
                <button id="save-table-btn" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg mt-4 transition-all">Salvar Mesa</button>
            </div>
        </div>
    </div>

    <!-- Table Details Modal -->
    <div id="table-details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-700 rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="table-details-title" class="text-xl font-semibold">Mesa <span id="table-number"></span></h3>
                <div>
                    <button id="edit-table-btn" class="text-gray-400 hover:text-white mr-3">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="close-table-details-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="mb-4 p-3 bg-dark-600 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="font-medium">Total:</span>
                    <span id="table-total" class="text-xl font-bold text-emerald-400">R$ 0,00</span>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-medium mb-2">Itens do Pedido</h4>
                <div id="order-items" class="space-y-2">
                    <!-- Order items will be added here dynamically -->
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-medium mb-2">Adicionar Item</h4>
                <div class="flex space-x-2">
                    <input type="text" id="new-item-name" placeholder="Nome do item" class="flex-1 bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                    <input type="number" id="new-item-price" placeholder="Preço" step="0.01" min="0" class="w-24 bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                    <button id="add-item-btn" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded transition-all">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <!-- Split Bill Section -->
            <div class="mb-4 p-4 bg-dark-600 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium">Dividir Conta</h4>
                    <button id="split-bill-btn" class="text-sm bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition-all">
                        <i class="fas fa-divide mr-1"></i> Dividir
                    </button>
                </div>
                <div id="split-bill-controls" class="hidden">
                    <div class="flex items-center space-x-2 mb-2">
                        <span>Dividir entre</span>
                        <input type="number" id="split-people" min="1" value="2" class="w-16 bg-dark-500 border border-dark-400 rounded px-2 py-1 text-center">
                        <span>pessoas</span>
                    </div>
                    <button id="calculate-split-btn" class="w-full py-1 bg-blue-600 hover:bg-blue-700 rounded transition-all">
                        Calcular Divisão
                    </button>
                </div>
                <div id="split-results" class="mt-3 space-y-2 hidden">
                    <div class="flex justify-between items-center border-b border-dark-500 pb-1">
                        <span class="font-medium">Divisão da conta:</span>
                        <button id="close-split-results" class="text-gray-400 hover:text-white text-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="split-items" class="grid grid-cols-2 gap-2">
                        <!-- Split items will be added here -->
                    </div>
                </div>
            </div>
            
            <button id="finalize-order-btn" class="w-full py-2 bg-red-600 hover:bg-red-700 rounded-lg mt-4 transition-all">Finalizar Pedido</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-700 rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Configurações</h3>
                <button id="close-settings-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Presets Section -->
                <div>
                    <h4 class="font-medium mb-3 flex items-center justify-between">
                        <span>Pré-definições</span>
                        <button id="add-preset-btn" class="text-sm text-emerald-400 hover:text-emerald-300">
                            <i class="fas fa-plus mr-1"></i> Adicionar
                        </button>
                    </h4>
                    <div id="presets-list" class="space-y-2">
                        <!-- Presets will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Sales History Section -->
                <div>
                    <h4 class="font-medium mb-3">Histórico de Vendas</h4>
                    <div class="mb-4 p-3 bg-dark-600 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Total de Vendas:</span>
                            <span id="total-sales" class="text-xl font-bold text-emerald-400">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mb-4">
                        <select id="history-filter" class="bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                            <option value="all">Todos</option>
                            <option value="day">Hoje</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mês</option>
                        </select>
                        <button id="clear-history-btn" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded transition-all">
                            Limpar Histórico
                        </button>
                        <button id="reset-total-btn" class="bg-amber-600 hover:bg-amber-700 px-3 py-2 rounded transition-all">
                            Zerar Total
                        </button>
                    </div>
                    
                    <div id="sales-history" class="space-y-3">
                        <!-- Sales history will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Preset Modal -->
    <div id="add-preset-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-700 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Adicionar Pré-definição</h3>
                <button id="close-add-preset-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2">Nome do Item</label>
                    <input type="text" id="preset-item-name" class="w-full bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block mb-2">Preço</label>
                    <input type="number" id="preset-item-price" step="0.01" min="0" class="w-full bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                </div>
                <button id="save-preset-btn" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg mt-4 transition-all">Salvar Item</button>
            </div>
        </div>
    </div>

    <!-- Edit Table Modal -->
    <div id="edit-table-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-700 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Editar Mesa</h3>
                <button id="close-edit-table-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2">Nome da Mesa</label>
                    <input type="text" id="edit-table-name" class="w-full bg-dark-600 border border-dark-500 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block mb-2">Cor da Mesa</label>
                    <div class="grid grid-cols-5 gap-2">
                        <div class="color-option h-8 rounded cursor-pointer bg-red-500 border-2 border-transparent hover:border-white" data-color="bg-red-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-blue-500 border-2 border-transparent hover:border-white" data-color="bg-blue-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-green-500 border-2 border-transparent hover:border-white" data-color="bg-green-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-yellow-500 border-2 border-transparent hover:border-white" data-color="bg-yellow-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-purple-500 border-2 border-transparent hover:border-white" data-color="bg-purple-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-pink-500 border-2 border-transparent hover:border-white" data-color="bg-pink-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-indigo-500 border-2 border-transparent hover:border-white" data-color="bg-indigo-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-emerald-500 border-2 border-transparent hover:border-white" data-color="bg-emerald-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-amber-500 border-2 border-transparent hover:border-white" data-color="bg-amber-500"></div>
                        <div class="color-option h-8 rounded cursor-pointer bg-cyan-500 border-2 border-transparent hover:border-white" data-color="bg-cyan-500"></div>
                    </div>
                </div>
                <button id="save-edit-table-btn" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg mt-4 transition-all">Salvar Alterações</button>
                <button id="delete-table-btn" class="w-full py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-all">Excluir Mesa</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        const state = {
            tables: [],
            presets: [],
            salesHistory: [],
            totalSales: 0,
            selectedTableId: null,
            selectedColor: 'bg-blue-500',
            selectedPresetId: null,
            storageAllowed: false
        };

        // DOM Elements
        const elements = {
            storagePermissionModal: document.getElementById('storage-permission-modal'),
            allowStorageBtn: document.getElementById('allow-storage-btn'),
            denyStorageBtn: document.getElementById('deny-storage-btn'),
            tablesContainer: document.getElementById('tables-container'),
            addTableBtn: document.getElementById('add-table-btn'),
            addTableModal: document.getElementById('add-table-modal'),
            closeAddTableModal: document.getElementById('close-add-table-modal'),
            tableName: document.getElementById('table-name'),
            saveTableBtn: document.getElementById('save-table-btn'),
            colorOptions: document.querySelectorAll('.color-option'),
            tableDetailsModal: document.getElementById('table-details-modal'),
            closeTableDetailsModal: document.getElementById('close-table-details-modal'),
            tableDetailsTitle: document.getElementById('table-details-title'),
            tableNumber: document.getElementById('table-number'),
            orderItems: document.getElementById('order-items'),
            newItemName: document.getElementById('new-item-name'),
            newItemPrice: document.getElementById('new-item-price'),
            addItemBtn: document.getElementById('add-item-btn'),
            tableTotal: document.getElementById('table-total'),
            finalizeOrderBtn: document.getElementById('finalize-order-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsModal: document.getElementById('close-settings-modal'),
            presetsList: document.getElementById('presets-list'),
            addPresetBtn: document.getElementById('add-preset-btn'),
            addPresetModal: document.getElementById('add-preset-modal'),
            closeAddPresetModal: document.getElementById('close-add-preset-modal'),
            presetItemName: document.getElementById('preset-item-name'),
            presetItemPrice: document.getElementById('preset-item-price'),
            savePresetBtn: document.getElementById('save-preset-btn'),
            salesHistory: document.getElementById('sales-history'),
            totalSales: document.getElementById('total-sales'),
            historyFilter: document.getElementById('history-filter'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            resetTotalBtn: document.getElementById('reset-total-btn'),
            editTableBtn: document.getElementById('edit-table-btn'),
            editTableModal: document.getElementById('edit-table-modal'),
            closeEditTableModal: document.getElementById('close-edit-table-modal'),
            editTableName: document.getElementById('edit-table-name'),
            saveEditTableBtn: document.getElementById('save-edit-table-btn'),
            deleteTableBtn: document.getElementById('delete-table-btn'),
            splitBillBtn: document.getElementById('split-bill-btn'),
            splitBillControls: document.getElementById('split-bill-controls'),
            splitPeople: document.getElementById('split-people'),
            calculateSplitBtn: document.getElementById('calculate-split-btn'),
            splitResults: document.getElementById('split-results'),
            closeSplitResults: document.getElementById('close-split-results'),
            splitItems: document.getElementById('split-items'),
            customAlertContainer: document.getElementById('custom-alert-container')
        };

        // Custom alert function
        function showAlert(message, type = 'success', duration = 3000) {
            const alert = document.createElement('div');
            alert.className = `custom-alert ${type}`;
            alert.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                <span>${message}</span>
            `;
            
            elements.customAlertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, duration);
        }

        // Check if storage permission was already granted
        function checkStoragePermission() {
            const permissionGranted = localStorage.getItem('storagePermissionGranted');
            if (permissionGranted === 'true') {
                state.storageAllowed = true;
                loadInitialData();
                return true;
            }
            return false;
        }

        // Load initial data from localStorage
        function loadInitialData() {
            try {
                const savedTables = localStorage.getItem('tables');
                const savedPresets = localStorage.getItem('presets');
                const savedSalesHistory = localStorage.getItem('salesHistory');
                const savedTotalSales = localStorage.getItem('totalSales');

                if (savedTables) state.tables = JSON.parse(savedTables);
                if (savedPresets) state.presets = JSON.parse(savedPresets);
                if (savedSalesHistory) state.salesHistory = JSON.parse(savedSalesHistory);
                if (savedTotalSales) state.totalSales = parseFloat(savedTotalSales);

                // If no tables exist, create a default one
                if (state.tables.length === 0) {
                    createDefaultTable();
                }
            } catch (e) {
                console.error('Error loading data from localStorage:', e);
                createDefaultTable();
            }
        }

        // Create a default table
        function createDefaultTable() {
            const defaultTable = {
                id: 'default-' + Date.now().toString(),
                name: 'Mesa 1',
                color: 'bg-blue-500',
                items: [],
                total: 0
            };
            
            state.tables.push(defaultTable);
            saveState();
        }

        // Initialize the app
        function init() {
            // Check if storage permission was already granted
            const permissionGranted = checkStoragePermission();
            
            if (!permissionGranted) {
                // Show storage permission modal
                elements.storagePermissionModal.classList.remove('hidden');
            } else {
                // Load data and render the app
                renderTables();
                renderPresets();
                renderSalesHistory();
                updateTotalSales();
            }
            
            setupEventListeners();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Storage permission
            elements.allowStorageBtn.addEventListener('click', () => {
                // Mark permission as granted
                localStorage.setItem('storagePermissionGranted', 'true');
                state.storageAllowed = true;
                
                // Hide the modal
                elements.storagePermissionModal.classList.add('hidden');
                
                // Load initial data and render the app
                loadInitialData();
                renderTables();
                renderPresets();
                renderSalesHistory();
                updateTotalSales();
                
                showAlert('Armazenamento local ativado com sucesso!', 'success');
            });
            
            elements.denyStorageBtn.addEventListener('click', () => {
                // Hide the modal
                elements.storagePermissionModal.classList.add('hidden');
                
                // Show warning that app won't work properly
                showAlert('O aplicativo pode não funcionar corretamente sem armazenamento local.', 'warning');
                
                // Create a default table anyway (won't be saved)
                createDefaultTable();
                renderTables();
            });

            // Add table
            elements.addTableBtn.addEventListener('click', () => {
                elements.addTableModal.classList.remove('hidden');
            });

            elements.closeAddTableModal.addEventListener('click', () => {
                elements.addTableModal.classList.add('hidden');
            });

            elements.saveTableBtn.addEventListener('click', addTable);

            // Color selection
            elements.colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.colorOptions.forEach(opt => opt.classList.remove('border-white', 'border-2'));
                    option.classList.add('border-white', 'border-2');
                    state.selectedColor = option.dataset.color;
                });
            });

            // Table details
            elements.closeTableDetailsModal.addEventListener('click', () => {
                elements.tableDetailsModal.classList.add('hidden');
            });

            elements.addItemBtn.addEventListener('click', addItemToTable);
            elements.newItemName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addItemToTable();
            });

            elements.newItemPrice.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addItemToTable();
            });

            elements.finalizeOrderBtn.addEventListener('click', finalizeOrder);

            // Settings
            elements.settingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.remove('hidden');
            });

            elements.closeSettingsModal.addEventListener('click', () => {
                elements.settingsModal.classList.add('hidden');
            });

            // Presets
            elements.addPresetBtn.addEventListener('click', () => {
                elements.addPresetModal.classList.remove('hidden');
            });

            elements.closeAddPresetModal.addEventListener('click', () => {
                elements.addPresetModal.classList.add('hidden');
            });

            elements.savePresetBtn.addEventListener('click', addPreset);

            // History
            elements.historyFilter.addEventListener('change', renderSalesHistory);
            elements.clearHistoryBtn.addEventListener('click', clearHistory);
            elements.resetTotalBtn.addEventListener('click', resetTotalSales);

            // Edit table
            elements.editTableBtn.addEventListener('click', () => {
                if (state.selectedTableId) {
                    const table = state.tables.find(t => t.id === state.selectedTableId);
                    if (table) {
                        elements.editTableName.value = table.name;
                        state.selectedColor = table.color;
                        
                        // Update color selection
                        elements.colorOptions.forEach(opt => {
                            opt.classList.remove('border-white', 'border-2');
                            if (opt.dataset.color === table.color) {
                                opt.classList.add('border-white', 'border-2');
                            }
                        });
                        
                        elements.editTableModal.classList.remove('hidden');
                    }
                }
            });

            elements.closeEditTableModal.addEventListener('click', () => {
                elements.editTableModal.classList.add('hidden');
            });

            elements.saveEditTableBtn.addEventListener('click', saveTableChanges);
            elements.deleteTableBtn.addEventListener('click', deleteTable);

            // Split bill functionality
            elements.splitBillBtn.addEventListener('click', () => {
                elements.splitBillControls.classList.toggle('hidden');
                if (!elements.splitBillControls.classList.contains('hidden')) {
                    elements.splitResults.classList.add('hidden');
                }
            });

            elements.calculateSplitBtn.addEventListener('click', calculateSplit);
            elements.closeSplitResults.addEventListener('click', () => {
                elements.splitResults.classList.add('hidden');
            });
        }

        // Calculate split bill
        function calculateSplit() {
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            const table = state.tables[tableIndex];
            const total = table.total;
            const peopleCount = parseInt(elements.splitPeople.value) || 2;
            
            if (peopleCount < 1) {
                showAlert('Por favor, insira um número válido de pessoas', 'warning');
                return;
            }
            
            // Calculate fair division
            const baseAmount = Math.floor((total * 100) / peopleCount) / 100;
            const remainder = Math.round((total - (baseAmount * peopleCount)) * 100);
            
            const amounts = [];
            for (let i = 0; i < peopleCount; i++) {
                amounts.push(baseAmount + (i < remainder ? 0.01 : 0));
            }
            
            // Display results
            elements.splitItems.innerHTML = '';
            amounts.forEach((amount, index) => {
                const item = document.createElement('div');
                item.className = 'bg-dark-500 p-2 rounded text-center fade-in';
                item.style.animationDelay = `${index * 0.1}s`;
                item.innerHTML = `
                    <div class="font-medium">Cliente ${index + 1}</div>
                    <div class="text-emerald-400 font-bold">R$ ${amount.toFixed(2)}</div>
                `;
                elements.splitItems.appendChild(item);
            });
            
            elements.splitResults.classList.remove('hidden');
            elements.splitBillControls.classList.add('hidden');
        }

        // Render tables
        function renderTables() {
            elements.tablesContainer.innerHTML = '';
            
            state.tables.forEach(table => {
                const tableElement = document.createElement('div');
                tableElement.className = `rounded-lg p-4 cursor-pointer transition-all hover:opacity-90 flex flex-col items-center justify-center ${table.color} h-24`;
                tableElement.innerHTML = `
                    <div class="font-semibold text-center">${table.name}</div>
                    <div class="mt-2 text-sm font-medium">Total: R$ ${table.total.toFixed(2)}</div>
                `;
                
                tableElement.addEventListener('click', () => {
                    state.selectedTableId = table.id;
                    openTableDetails(table);
                });
                
                elements.tablesContainer.appendChild(tableElement);
            });
        }

        // Open table details
        function openTableDetails(table) {
            elements.tableNumber.textContent = table.name;
            elements.tableDetailsTitle.textContent = `Mesa ${table.name}`;
            renderOrderItems(table.items);
            updateTableTotal(table.items);
            
            // Reset split bill UI
            elements.splitBillControls.classList.add('hidden');
            elements.splitResults.classList.add('hidden');
            
            elements.tableDetailsModal.classList.remove('hidden');
        }

        // Render order items
        function renderOrderItems(items) {
            elements.orderItems.innerHTML = '';
            
            if (items.length === 0) {
                elements.orderItems.innerHTML = '<div class="text-gray-400 text-center py-4">Nenhum item adicionado</div>';
                return;
            }
            
            items.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center p-2 bg-dark-600 rounded';
                itemElement.innerHTML = `
                    <div>
                        <span class="font-medium">${item.name}</span>
                        <span class="text-sm text-gray-400 ml-2">x${item.quantity}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="font-medium mr-3">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                        <button class="increment-btn text-emerald-400 hover:text-emerald-300 mr-2" data-index="${index}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="decrement-btn text-red-400 hover:text-red-300" data-index="${index}">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                `;
                
                elements.orderItems.appendChild(itemElement);
            });
            
            // Add event listeners to increment/decrement buttons
            document.querySelectorAll('.increment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    incrementItemQuantity(index);
                });
            });
            
            document.querySelectorAll('.decrement-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    decrementItemQuantity(index);
                });
            });
        }

        // Update table total
        function updateTableTotal(items) {
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            elements.tableTotal.textContent = `R$ ${total.toFixed(2)}`;
            
            // Update the table in state
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex !== -1) {
                state.tables[tableIndex].total = total;
                saveState();
                renderTables();
            }
        }

        // Add table
        function addTable() {
            const name = elements.tableName.value.trim();
            
            if (!name) {
                showAlert('Por favor, insira um nome para a mesa', 'warning');
                return;
            }
            
            const newTable = {
                id: Date.now().toString(),
                name,
                color: state.selectedColor,
                items: [],
                total: 0
            };
            
            // Add preset items if any
            if (state.presets.length > 0) {
                newTable.items = state.presets.map(preset => ({
                    name: preset.name,
                    price: preset.price,
                    quantity: 0
                }));
            }
            
            state.tables.push(newTable);
            saveState();
            renderTables();
            
            // Reset form
            elements.tableName.value = '';
            elements.addTableModal.classList.add('hidden');
            
            // Pulse animation on the new table
            const newTableElement = elements.tablesContainer.lastChild;
            newTableElement.classList.add('animate-pulse-once');
            setTimeout(() => {
                newTableElement.classList.remove('animate-pulse-once');
            }, 500);
            
            showAlert(`Mesa ${name} adicionada com sucesso!`, 'success');
        }

        // Add item to table
        function addItemToTable() {
            const name = elements.newItemName.value.trim();
            const price = parseFloat(elements.newItemPrice.value);
            
            if (!name || isNaN(price) || price <= 0) {
                showAlert('Por favor, insira um nome e um preço válido para o item', 'warning');
                return;
            }
            
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            // Check if item already exists
            const existingItemIndex = state.tables[tableIndex].items.findIndex(
                item => item.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingItemIndex !== -1) {
                // Increment quantity if item exists
                state.tables[tableIndex].items[existingItemIndex].quantity += 1;
                showAlert(`Quantidade de "${name}" aumentada para ${state.tables[tableIndex].items[existingItemIndex].quantity}`, 'success');
            } else {
                // Add new item
                state.tables[tableIndex].items.push({
                    name,
                    price,
                    quantity: 1
                });
                showAlert(`"${name}" adicionado à mesa`, 'success');
            }
            
            saveState();
            renderOrderItems(state.tables[tableIndex].items);
            updateTableTotal(state.tables[tableIndex].items);
            
            // Reset form
            elements.newItemName.value = '';
            elements.newItemPrice.value = '';
            elements.newItemName.focus();
        }

        // Increment item quantity
        function incrementItemQuantity(index) {
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            state.tables[tableIndex].items[index].quantity += 1;
            saveState();
            renderOrderItems(state.tables[tableIndex].items);
            updateTableTotal(state.tables[tableIndex].items);
        }

        // Decrement item quantity
        function decrementItemQuantity(index) {
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            if (state.tables[tableIndex].items[index].quantity > 1) {
                state.tables[tableIndex].items[index].quantity -= 1;
            } else {
                // Remove item if quantity reaches 0
                const itemName = state.tables[tableIndex].items[index].name;
                state.tables[tableIndex].items.splice(index, 1);
                showAlert(`"${itemName}" removido do pedido`, 'success');
            }
            
            saveState();
            renderOrderItems(state.tables[tableIndex].items);
            updateTableTotal(state.tables[tableIndex].items);
        }

        // Finalize order
        function finalizeOrder() {
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            const table = state.tables[tableIndex];
            
            if (table.items.length === 0 || table.items.every(item => item.quantity === 0)) {
                showAlert('Adicione itens ao pedido antes de finalizar', 'warning');
                return;
            }
            
            // Filter out items with quantity 0
            const soldItems = table.items.filter(item => item.quantity > 0);
            
            // Add to sales history
            const sale = {
                id: Date.now().toString(),
                tableName: table.name,
                date: new Date().toISOString(),
                items: soldItems,
                total: table.total
            };
            
            state.salesHistory.unshift(sale);
            state.totalSales += table.total;
            
            // Reset table
            table.items = [];
            table.total = 0;
            
            // If there are presets, add them back with quantity 0
            if (state.presets.length > 0) {
                table.items = state.presets.map(preset => ({
                    name: preset.name,
                    price: preset.price,
                    quantity: 0
                }));
            }
            
            saveState();
            renderTables();
            renderSalesHistory();
            updateTotalSales();
            elements.tableDetailsModal.classList.add('hidden');
            
            // Show success message
            showAlert(`Pedido da mesa ${table.name} finalizado! Total: R$ ${sale.total.toFixed(2)}`, 'success');
        }

        // Render presets
        function renderPresets() {
            elements.presetsList.innerHTML = '';
            
            if (state.presets.length === 0) {
                elements.presetsList.innerHTML = '<div class="text-gray-400 text-center py-4">Nenhuma pré-definição cadastrada</div>';
                return;
            }
            
            state.presets.forEach((preset, index) => {
                const presetElement = document.createElement('div');
                presetElement.className = 'flex justify-between items-center p-2 bg-dark-600 rounded';
                presetElement.innerHTML = `
                    <div>
                        <span class="font-medium">${preset.name}</span>
                        <span class="text-sm text-gray-400 ml-2">R$ ${preset.price.toFixed(2)}</span>
                    </div>
                    <div>
                        <button class="delete-preset-btn text-red-400 hover:text-red-300" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                elements.presetsList.appendChild(presetElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    deletePreset(index);
                });
            });
        }

        // Add preset
        function addPreset() {
            const name = elements.presetItemName.value.trim();
            const price = parseFloat(elements.presetItemPrice.value);
            
            if (!name || isNaN(price) || price <= 0) {
                showAlert('Por favor, insira um nome e um preço válido para o item', 'warning');
                return;
            }
            
            const newPreset = {
                id: Date.now().toString(),
                name,
                price
            };
            
            state.presets.push(newPreset);
            saveState();
            renderPresets();
            
            // Add preset to all tables with quantity 0
            state.tables.forEach(table => {
                // Check if preset already exists in table
                const exists = table.items.some(item => item.name.toLowerCase() === name.toLowerCase());
                
                if (!exists) {
                    table.items.push({
                        name,
                        price,
                        quantity: 0
                    });
                }
            });
            
            saveState();
            renderTables();
            
            // Reset form
            elements.presetItemName.value = '';
            elements.presetItemPrice.value = '';
            elements.addPresetModal.classList.add('hidden');
            
            showAlert(`Pré-definição "${name}" adicionada com sucesso!`, 'success');
        }

        // Delete preset
        function deletePreset(index) {
            const presetName = state.presets[index].name;
            state.presets.splice(index, 1);
            saveState();
            renderPresets();
            
            // Remove preset from all tables where quantity is 0
            state.tables.forEach(table => {
                table.items = table.items.filter(item => {
                    // Keep items that are not presets or have quantity > 0
                    return item.quantity > 0 || 
                           state.presets.some(preset => preset.name.toLowerCase() === item.name.toLowerCase());
                });
            });
            
            saveState();
            renderTables();
            
            showAlert(`Pré-definição "${presetName}" removida`, 'success');
        }

        // Render sales history
        function renderSalesHistory() {
            elements.salesHistory.innerHTML = '';
            
            if (state.salesHistory.length === 0) {
                elements.salesHistory.innerHTML = '<div class="text-gray-400 text-center py-4">Nenhum histórico de vendas</div>';
                return;
            }
            
            const filter = elements.historyFilter.value;
            let filteredHistory = [...state.salesHistory];
            
            if (filter !== 'all') {
                const now = new Date();
                filteredHistory = filteredHistory.filter(sale => {
                    const saleDate = new Date(sale.date);
                    
                    if (filter === 'day') {
                        return saleDate.toDateString() === now.toDateString();
                    } else if (filter === 'week') {
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        return saleDate >= startOfWeek;
                    } else if (filter === 'month') {
                        return saleDate.getMonth() === now.getMonth() && 
                               saleDate.getFullYear() === now.getFullYear();
                    }
                    return true;
                });
            }
            
            if (filteredHistory.length === 0) {
                elements.salesHistory.innerHTML = '<div class="text-gray-400 text-center py-4">Nenhuma venda encontrada para o período selecionado</div>';
                return;
            }
            
            filteredHistory.forEach(sale => {
                const saleElement = document.createElement('div');
                saleElement.className = 'p-3 bg-dark-600 rounded-lg';
                
                const saleDate = new Date(sale.date);
                const formattedDate = saleDate.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                saleElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">Mesa ${sale.tableName}</span>
                        <span class="text-sm text-gray-400">${formattedDate}</span>
                    </div>
                    <div class="mb-2">
                        ${sale.items.map(item => `
                            <div class="flex justify-between text-sm">
                                <span>${item.name} x${item.quantity}</span>
                                <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-dark-500">
                        <span class="font-medium">Total:</span>
                        <span class="font-bold text-emerald-400">R$ ${sale.total.toFixed(2)}</span>
                    </div>
                `;
                
                elements.salesHistory.appendChild(saleElement);
            });
        }

        // Update total sales
        function updateTotalSales() {
            elements.totalSales.textContent = `R$ ${state.totalSales.toFixed(2)}`;
        }

        // Clear history
        function clearHistory() {
            state.salesHistory = [];
            saveState();
            renderSalesHistory();
            showAlert('Histórico de vendas limpo com sucesso', 'success');
        }

        // Reset total sales
        function resetTotalSales() {
            state.totalSales = 0;
            saveState();
            updateTotalSales();
            showAlert('Total de vendas zerado com sucesso', 'success');
        }

        // Save table changes
        function saveTableChanges() {
            const name = elements.editTableName.value.trim();
            
            if (!name) {
                showAlert('Por favor, insira um nome para a mesa', 'warning');
                return;
            }
            
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            state.tables[tableIndex].name = name;
            state.tables[tableIndex].color = state.selectedColor;
            
            saveState();
            renderTables();
            elements.tableNumber.textContent = name;
            elements.tableDetailsTitle.textContent = `Mesa ${name}`;
            elements.editTableModal.classList.add('hidden');
            
            showAlert(`Mesa "${name}" atualizada com sucesso`, 'success');
        }

        // Delete table
        function deleteTable() {
            const tableIndex = state.tables.findIndex(t => t.id === state.selectedTableId);
            if (tableIndex === -1) return;
            
            const tableName = state.tables[tableIndex].name;
            state.tables.splice(tableIndex, 1);
            saveState();
            renderTables();
            elements.editTableModal.classList.add('hidden');
            elements.tableDetailsModal.classList.add('hidden');
            
            showAlert(`Mesa "${tableName}" excluída com sucesso`, 'success');
        }

        // Save state to localStorage
        function saveState() {
            if (!state.storageAllowed) return;
            
            try {
                localStorage.setItem('tables', JSON.stringify(state.tables));
                localStorage.setItem('presets', JSON.stringify(state.presets));
                localStorage.setItem('salesHistory', JSON.stringify(state.salesHistory));
                localStorage.setItem('totalSales', state.totalSales.toString());
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                showAlert('Erro ao salvar dados localmente', 'error');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=okias33/teste123" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>